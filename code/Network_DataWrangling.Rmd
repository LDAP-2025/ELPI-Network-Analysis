---
title: "DataWrangling"
author: "Greta Dertwinkel"
date: "2025-06-02"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set Up
```{r set-up}
# Load necessary packages (install if not present)
packages <- c("tidyverse", "haven", "dplyr", "ggplot2")
lapply(packages, function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
  library(pkg, character.only = TRUE)
})
```

# Read in Data Wave 1 
```{r data-wave1}
# create a separate data file for wave 1
raw_data_wave1 <- read_dta("../data/Evaluaciones_2010.dta")

#Filter data to only include participant identifier (folio), age (edad_meses) and any column heading starting with cbcl (items on the child behaviour checklist)
data_wave1 <- raw_data_wave1 %>%
  select(folio, edad_meses, starts_with("cbcl"))
```

## Format Wave 1 Data into Long Format
```{r long-format-wave1}
# Convert cbcl to long format for Wave 1 data 
cbcl_long_wave1 <- data_wave1 %>%
  pivot_longer(cols = -folio,
               names_to = "category",
               values_to = "score")

# Create category labels 
category_labels <- c(
  "cbcl1_pb_1" = "Emotional_Reactivity",
  "cbcl1_pb_2" = "Anxiety_or_Depression",
  "cbcl1_pb_3" = "Somatic_Complaints",
  "cbcl1_pb_4" = "Social_Problems",
  "cbcl1_pb_5" = "Sleep_Problems",
  "cbcl1_pb_6" = "Attention_Issues",
  "cbcl1_pb_7" = "Agressive_Conduct",
  "cbcl1_pb_t" = "Total_CBCL_Score") 

# Change category labels and only include those in the final dataset
cbcl_long_wave1 <- cbcl_long_wave1 %>%
  mutate(category = recode(category, !!!category_labels)) %>%
  filter(category %in% c("Emotional_Reactivity", "Anxiety_or_Depression", "Somatic_Complaints", "Social_Problems", "Sleep_Problems", "Attention_Issues", "Agressive_Conduct", "Total_CBCL_Score"))
```

# Read in Data Wave 2
```{r data-wave2}
# create a separate data file for wave 2
raw_data_wave2 <- read_dta("../data/Evaluaciones_2012.dta")

#Filter data to only include participant identifier (folio), age (edad_meses) and any column heading starting with cbcl (items on the child behaviour checklist)
data_wave2 <- raw_data_wave2 %>%
  select(folio, edad_meses, starts_with("cbcl"))
```

## Format Wave 2 Data into Long Format
```{r long-format-wave1}
# Convert cbcl to long format for Wave 1 data 
cbcl_long_wave2 <- data_wave2 %>%
  pivot_longer(cols = -folio,
               names_to = "category",
               values_to = "score")

# Change category labels and only include those in the final dataset
cbcl_long_wave2 <- cbcl_long_wave2 %>%
  mutate(category = recode(category, !!!category_labels)) %>%
  filter(category %in% c("Emotional_Reactivity", "Anxiety_or_Depression", "Somatic_Complaints", "Social_Problems", "Sleep_Problems", "Attention_Issues", "Agressive_Conduct", "Total_CBCL_Score"))
```

# Read in Data Wave 3
```{r data-wave3}
# create a separate data file for wave 3
raw_data_wave3 <- read_sav("../data/Evaluaciones_2017.sav")

#Filter data to only include participant identifier (folio), age (edad_meses) and any column heading starting with cbcl (items on the child behaviour checklist)
data_wave3 <- raw_data_wave3 %>%
  select(folio, edad_mesesr, starts_with("cbcl"))
```

## Format Wave 3 Data into Long Format
```{r long-format-wave1}
#Convert cbcl to Long format for Wave 1 data 
cbcl_long_wave3 <- data_wave3 %>%
  pivot_longer( cols = -folio,
                names_to = "category",
                values_to = "score")

cbcl_long_wave3 <- cbcl_long_wave3 %>%
  mutate(category = recode(category, !!!category_labels)) %>%
  filter(category %in% c("Emotional_Reactivity", "Anxiety_or_Depression", "Somatic_Complaints", "Social_Problems", "Sleep_Problems", "Attention_Issues", "Agressive_Conduct", "Total_CBCL_Score")) %>%
  drop_na()
```

# Read in Data from Wave 1 for Alcohol Use 
```{r alcoholuse-wave1}
# create a separate data file for wave 1 for Alcohol Use
data_SU_W1 <- read_dta("../data/Entrevistada_2010.dta")

#Filter data to only include participant identifier "folio" and columns with alcohol use report "G9: Asking During pregnancy did you consume an alcoholic beverage?
alcohol_use_data <- data_SU_W1 %>%
  select(folio, starts_with("g9"))
```

# Data Exploration

## Visualisation of Alcohol Use
```{r alcohol-use-explorartion}
# create a bar plot of responses to g9
ggplot(alcohol_use_data, aes(x = factor(g9))) +
  geom_bar(fill = "#9467bd") +
  labs(x = "During pregnancy did you consume an alcoholic beverage?", 
       y = "Count", 
       title = "Alcohol Use During Pregnancy") +
  scale_x_discrete(labels = c("Never", "Sporadically", "Regularly", "No Response")) +
  theme_minimal()
```

## Visualisation of CBCL Scores across Time
```{r cbcl-across-waves}
# Plot without Total Score
cbcl_long_wave1 %>%
  filter(category != "Total Score CBCL") %>%
  ggplot(aes(x = category, y = score, group = folio, colour = folio)) +
  geom_line(alpha = 0.2) +
  labs(title = "CBCL Subscale Scores per Participant",
       x = "CBCL Category", y = "Score") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Plot only Total Score
cbcl_long_wave1 %>%
  filter(category == "Total Score CBCL") %>%
  ggplot(aes(x = folio, y = score)) +
  geom_col() +
  labs(title = "Total CBCL Scores per Participant",
       x = "Participant ID", y = "Total Score") +
  theme_minimal() +
  theme(axis.text.x = element_blank())
```


```{r}
#Plotting Only Random Subset of Participants to obtain clearer visualsiation

# Step 1: Set seed and sample 50 participants
set.seed(123)  # for reproducibility
sample_ids <- cbcl_long_wave1 %>%
  distinct(folio) %>%
  sample_n(50) %>%
  pull(folio)

# Separate data
subscale_data <- cbcl_long_wave1 %>%
  filter(folio %in% sample_ids, category != "Total Score CBCL")


#  Plot subscale scores per participant
ggplot(subscale_data, aes(x = category, y = score, group = folio)) +
  geom_line(alpha = 0.4) +
  labs(title = "CBCL Subscale Scores per Participant (Sample of 50)",
       x = "CBCL Category", y = "Score") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Make spagetti plot considering time variable in the x and faceted by category of the cbcl (one graph for each)
```

